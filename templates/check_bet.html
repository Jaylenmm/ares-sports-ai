{% extends 'base.html' %}
{% block title %}Check your bet{% endblock %}
{% block content %}
<div class="space-y-4">
    <h1 class="text-xl font-bold text-white">Check your bet</h1>

    <!-- Saved setups -->
    <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-semibold">What you're cookin'</h2>
            <button id="refresh-parlays" class="text-sm px-3 py-1 rounded-xl border border-slate-300">Refresh</button>
        </div>
        <div id="parlays" class="mt-3 space-y-3">
            <div class="text-slate-600 text-sm">Nothing here. Search for your picks below!</div>
        </div>
    </div>

    <!-- Search -->
    <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3">
        <input id="search-input" type="text" placeholder="Search team or player" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none" />
        <div id="suggestions" class="mt-2 space-y-1"></div>
    </div>

    <!-- Options -->
    <div id="bet-options" class="space-y-2"></div>
</div>

<script>
// Orange border glow pulse CSS
const styleEl = document.createElement('style');
styleEl.textContent = `
@keyframes ringPulseOrange {
  0% { box-shadow: 0 0 0 4px rgba(249,115,22,0.45), 0 0 24px rgba(249,115,22,0.55); }
  50% { box-shadow: 0 0 0 6px rgba(249,115,22,0.65), 0 0 36px rgba(249,115,22,0.75); }
  100% { box-shadow: 0 0 0 4px rgba(249,115,22,0.45), 0 0 24px rgba(249,115,22,0.55); }
}
.animate-ring-pulse-orange { animation: ringPulseOrange 1.8s ease-in-out infinite; }
`;
document.head.appendChild(styleEl);

let debounceTimer;
const input = document.getElementById('search-input');
const suggestions = document.getElementById('suggestions');
const optionsDiv = document.getElementById('bet-options');
const parlaysDiv = document.getElementById('parlays');
document.getElementById('refresh-parlays').addEventListener('click', loadParlays);
// Shared title-case helper
const toTitle = (s) => (s||'').toLowerCase().split(' ').map(w=> w ? (w[0].toUpperCase()+w.slice(1)) : '').join(' ');

input.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  const q = input.value.trim();
  if (!q) {
    suggestions.innerHTML = '';
    return;
  }
  debounceTimer = setTimeout(async () => {
    const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if (!Array.isArray(data)) return;
    suggestions.innerHTML = '';
    for (const s of data) {
      const a = document.createElement('button');
      a.className = 'w-full text-left px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50';
      a.textContent = `${s.name}`;
      a.onclick = () => selectEntity(s.name);
      suggestions.appendChild(a);
    }
  }, 200);
});

async function selectEntity(name) {
  suggestions.innerHTML = '';
  input.value = name;
  optionsDiv.innerHTML = '<div class="text-slate-300">Loading game cards...</div>';
  try {
    const res = await fetch(`/api/check_bet_games?q=${encodeURIComponent(name)}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    renderGameCards(data.games || []);
  } catch (e) {
    optionsDiv.innerHTML = `<div class="text-red-400">${e.message}</div>`;
  }
}

function renderOptions(opts) {
  if (!opts.length) {
    optionsDiv.innerHTML = '<div class="text-slate-300">No betting options found.</div>';
    return;
  }
  // Sort by probability desc (treat nulls as lowest)
  const sorted = [...opts].sort((a,b) => (b.probability??-1) - (a.probability??-1));
  optionsDiv.innerHTML = '';
  sorted.forEach((o, idx) => {
    const card = document.createElement('div');
    const isTop = idx === 0;
    const highlightClass = isTop ? ' border-2 border-orange-500 animate-ring-pulse-orange ' : '';
    card.className = 'bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3 relative' + highlightClass;
    card.innerHTML = `
      ${isTop ? '<div class="absolute top-2 right-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-lg shadow">Top pick</div>' : ''}
      <div class="text-xs uppercase tracking-wide text-slate-700">${(o.sport || '').toUpperCase()}</div>
      <div class="mt-1 font-semibold">${o.teams ? toTitle(o.teams) : (o.team ? (toTitle(o.team) + ' vs ' + toTitle(o.opponent || '')) : '')}</div>
      <div class="text-sm text-slate-700">${o.date ? new Date(o.date).toLocaleString('en-US', { timeZone: 'America/New_York' }) + ' ET' : ''}</div>
      <div class="mt-2 text-sm">
        <div><span class="font-semibold">Type:</span> ${o.type}</div>
        ${o.price !== undefined ? `<div><span class="font-semibold">Price:</span> ${o.price}</div>` : ''}
        ${o.line !== undefined ? `<div><span class="font-semibold">Line:</span> ${o.line}</div>` : ''}
        ${o.probability !== null && o.probability !== undefined ? `<div><span class="font-semibold">Hit %:</span> ${o.probability}%</div>` : ''}
        ${o.reason ? `<div class="text-slate-700 mt-1">${o.reason}</div>` : ''}
      </div>
      <div class="mt-3">
        <button class="w-full bg-black text-white rounded-xl py-2" onclick='openSaveModal(${JSON.stringify(o)})'>Save bet</button>
      </div>
    `;
    optionsDiv.appendChild(card);
  });
}

function renderGameCards(games) {
  if (!games.length) {
    optionsDiv.innerHTML = '<div class="text-slate-300">No games found.</div>';
    return;
  }
  optionsDiv.innerHTML = '';
  for (const g of games) {
    const card = document.createElement('div');
    card.className = 'bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3 space-y-2';
    const title = document.createElement('div');
    const homeML = (g.home_moneyline!==null && g.home_moneyline!==undefined) ? `(${g.home_moneyline})` : '';
    const awayML = (g.away_moneyline!==null && g.away_moneyline!==undefined) ? `(${g.away_moneyline})` : '';
    title.className = 'font-semibold';
    title.textContent = `${toTitle(g.away_team)} ${awayML} @ ${toTitle(g.home_team)} ${homeML}`;
    const sub = document.createElement('div');
    sub.className = 'text-sm text-slate-700';
    sub.textContent = `${new Date(g.date).toLocaleString('en-US', { timeZone: 'America/New_York' })} ET · ${g.sport.toUpperCase()}${g.bookmaker ? ' · ' + g.bookmaker : ''}`;
    card.appendChild(title);
    card.appendChild(sub);
    if (g.spread!==null && g.spread!==undefined) {
      const spread = document.createElement('div');
      spread.className = 'text-sm';
      spread.textContent = `Spread: ${g.spread}`;
      card.appendChild(spread);
    }
    if (g.total!==null && g.total!==undefined) {
      const total = document.createElement('div');
      total.className = 'text-sm';
      total.textContent = `Total: ${g.total}`;
      card.appendChild(total);
    }
    // Picks buttons
    const picks = document.createElement('div');
    picks.className = 'grid grid-cols-2 gap-2';
    const buttons = [];
    // ML buttons
    if (g.away_moneyline!==null && g.away_moneyline!==undefined)
      buttons.push({ label: `${toTitle(g.away_team)} ML ${g.away_moneyline>0?'+':''}${g.away_moneyline}`, payload: { type:'moneyline', team:g.away_team, opponent:g.home_team, price:g.away_moneyline } });
    if (g.home_moneyline!==null && g.home_moneyline!==undefined)
      buttons.push({ label: `${toTitle(g.home_team)} ML ${g.home_moneyline>0?'+':''}${g.home_moneyline}`, payload: { type:'moneyline', team:g.home_team, opponent:g.away_team, price:g.home_moneyline } });
    // Spread buttons (home spread is g.spread; away is negative of that)
    if (g.spread!==null && g.spread!==undefined) {
      buttons.push({ label: `${toTitle(g.home_team)} spread ${g.spread>0?'+':''}${g.spread}`, payload: { type:'spread', team:g.home_team, opponent:g.away_team, line:g.spread } });
      const awayLine = (g.spread!==null && g.spread!==undefined) ? (g.spread*-1) : null;
      buttons.push({ label: `${toTitle(g.away_team)} spread ${awayLine>0?'+':''}${awayLine}`, payload: { type:'spread', team:g.away_team, opponent:g.home_team, line:awayLine } });
    }
    // Total buttons
    if (g.total!==null && g.total!==undefined) {
      buttons.push({ label: `Over ${g.total}`, payload: { type:'total', line:g.total } });
      buttons.push({ label: `Under ${g.total}`, payload: { type:'total', line:g.total } });
    }
    for (const b of buttons) {
      const btn = document.createElement('button');
      btn.className = 'bg-white text-black rounded-xl border border-slate-300 px-3 py-2 text-sm text-left hover:bg-slate-50';
      btn.textContent = b.label;
      btn.onclick = () => openSaveModal({ ...b.payload, sport:g.sport, game_id:g.game_id, date:g.date });
      picks.appendChild(btn);
    }
    card.appendChild(picks);
    optionsDiv.appendChild(card);
  }
}

// Save modal logic
let pendingBet = null;
function openSaveModal(o) {
  pendingBet = o;
  document.getElementById('save-modal').classList.remove('hidden');
}
function closeSaveModal() {
  document.getElementById('save-modal').classList.add('hidden');
  pendingBet = null;
}
async function confirmSaveBet() {
  if (!pendingBet) return;
  const isParlay = document.getElementById('opt-parlay').checked;
  const group_type = isParlay ? 'parlay' : 'single';
  let parlay_name = '';
  if (isParlay) {
    const sel = document.getElementById('existing-parlay');
    const existing = sel.value;
    const custom = document.getElementById('new-parlay-name').value.trim();
    parlay_name = custom || existing;
  }
  try {
    const payload = { ...pendingBet, group_type, parlay_name };
    const res = await fetch('/api/bets/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    closeSaveModal();
    await loadParlays();
    alert('Saved!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function loadParlays() {
  try {
    const res = await fetch('/api/parlays');
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    const list = data.parlays || [];
    if (!list.length) {
      parlaysDiv.innerHTML = '<div class="text-slate-600 text-sm">Nothing here. Search for your picks below!</div>';
      return;
    }
    parlaysDiv.innerHTML = '';
    for (const p of list) {
      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl border border-slate-200 p-3';
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between';
      header.innerHTML = `<div class="font-semibold">${p.name}</div><div class="text-xs text-slate-600 uppercase">${p.status}</div>`;
      wrap.appendChild(header);
      const bets = document.createElement('div');
      bets.className = 'mt-2 space-y-2';
      for (const b of p.bets) {
        const row = document.createElement('div');
        row.className = 'bg-white text-black rounded-xl border border-slate-200 p-2 flex items-center justify-between';
        const left = document.createElement('div');
        left.innerHTML = `<div class="text-xs uppercase text-slate-600">${(b.sport||'').toUpperCase()}</div><div class="font-medium">${toTitle(b.team||'')} vs ${toTitle(b.opponent||'')}</div><div class="text-xs text-slate-600">${b.date ? new Date(b.date).toLocaleString('en-US', { timeZone: 'America/New_York' }) + ' ET' : ''}</div>`;
        const right = document.createElement('div');
        right.className = 'text-right text-sm flex items-center space-x-3';
        const details = document.createElement('div');
        details.innerHTML = `${b.type ? `<div>${b.type}</div>` : ''}${(b.line!==null&&b.line!==undefined) ? `<div>Line: ${b.line}</div>` : ''}${(b.price!==null&&b.price!==undefined) ? `<div>Price: ${b.price}</div>` : ''}${(b.probability!==null&&b.probability!==undefined) ? `<div>Hit %: ${b.probability}</div>` : ''}`;
        const del = document.createElement('button');
        del.className = 'px-2 py-1 rounded-lg border border-red-300 text-red-600 hover:bg-red-50';
        del.textContent = '−';
        del.title = 'Remove pick';
        del.onclick = async () => {
          try {
            const res = await fetch('/api/bets/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: b.id }) });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Failed');
            await loadParlays();
          } catch (e) { alert('Error: ' + e.message); }
        };
        right.appendChild(details);
        right.appendChild(del);
        row.appendChild(left);
        row.appendChild(right);
        bets.appendChild(row);
      }
      wrap.appendChild(bets);
      parlaysDiv.appendChild(wrap);
    }
  } catch (e) {
    parlaysDiv.innerHTML = `<div class=\"text-red-500\">Error loading: ${e.message}</div>`;
  }
}

// Prefill from ?s=TEAM query and auto-run
(() => {
  const params = new URLSearchParams(window.location.search);
  const s = params.get('s');
  if (s) {
    input.value = s;
    selectEntity(s);
  }
})();
</script>
<!-- Save Modal -->
<div id="save-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-lg w-full max-w-md p-4">
    <h3 class="text-lg font-semibold mb-2">Add this to a parlay?</h3>
    <p class="text-sm text-slate-700 mb-3">Choose Single to save alone, or add to an existing/new parlay. Up to 5 active setups.</p>
    <div class="space-y-2">
      <label class="flex items-center space-x-2"><input type="radio" name="save-type" id="opt-single" checked> <span>Single</span></label>
      <label class="flex items-center space-x-2"><input type="radio" name="save-type" id="opt-parlay"> <span>Parlay</span></label>
      <div id="parlay-controls" class="ml-6 space-y-2 hidden">
        <div>
          <label class="block text-sm text-slate-700">Existing parlay</label>
          <select id="existing-parlay" class="w-full px-3 py-2 rounded-xl border border-slate-300"></select>
        </div>
        <div>
          <label class="block text-sm text-slate-700">Or new parlay name</label>
          <input id="new-parlay-name" class="w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="e.g., Sunday Picks" />
        </div>
      </div>
    </div>
    <div class="mt-4 flex justify-end space-x-2">
      <button class="px-4 py-2 rounded-xl border" onclick="closeSaveModal()">Cancel</button>
      <button class="px-4 py-2 rounded-xl bg-black text-white" onclick="confirmSaveBet()">Save</button>
    </div>
  </div>
</div>
<script>
// Toggle parlay controls
function updateParlayControls() {
  const show = document.getElementById('opt-parlay').checked;
  document.getElementById('parlay-controls').classList.toggle('hidden', !show);
}
document.getElementById('opt-single').addEventListener('change', updateParlayControls);
document.getElementById('opt-parlay').addEventListener('change', async () => {
  updateParlayControls();
  // load existing parlays into select
  try {
    const res = await fetch('/api/parlays');
    const data = await res.json();
    const sel = document.getElementById('existing-parlay');
    sel.innerHTML = '';
    (data.parlays||[]).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  } catch {}
});
updateParlayControls();
// Initial load
loadParlays();
</script>
{% endblock %}

