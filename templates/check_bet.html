{% extends 'base.html' %}
{% block title %}Check your bet{% endblock %}
{% block content %}
<div class="space-y-4">
    <h1 class="text-xl font-bold text-white">Check your bet</h1>

    <!-- Saved setups -->
    <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3">
        <div class="flex items-center justify-between">
            <h2 class="text-base font-semibold">What you're cookin'</h2>
            <button id="refresh-parlays" class="text-sm px-3 py-1 rounded-xl border border-slate-300">Refresh</button>
        </div>
        <div id="parlays" class="mt-3 space-y-3">
            <div class="text-slate-600 text-sm">Nothing here. Search for your picks below!</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2">
      <button id="tab-teams" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white text-black">Teams</button>
      <button id="tab-players" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white text-black">Players</button>
    </div>

    <!-- Search -->
    <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3">
        <input id="search-input" type="text" placeholder="Search team or player" class="w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none" />
        <div id="suggestions" class="mt-2 space-y-1"></div>
    </div>

    <!-- Options -->
    <div id="bet-options" class="space-y-2"></div>
</div>

<script>
// Orange border glow pulse CSS
const styleEl = document.createElement('style');
styleEl.textContent = `
@keyframes ringPulseOrange {
  0% { box-shadow: 0 0 0 4px rgba(249,115,22,0.45), 0 0 24px rgba(249,115,22,0.55); }
  50% { box-shadow: 0 0 0 6px rgba(249,115,22,0.65), 0 0 36px rgba(249,115,22,0.75); }
  100% { box-shadow: 0 0 0 4px rgba(249,115,22,0.45), 0 0 24px rgba(249,115,22,0.55); }
}
.animate-ring-pulse-orange { animation: ringPulseOrange 1.8s ease-in-out infinite; }
@keyframes pickPulse {
  0% { box-shadow: 0 0 0 2px rgba(96,165,250,0.4), 0 0 14px rgba(16,185,129,0.4); }
  33% { box-shadow: 0 0 0 3px rgba(16,185,129,0.5), 0 0 18px rgba(167,139,250,0.5); }
  66% { box-shadow: 0 0 0 3px rgba(167,139,250,0.5), 0 0 18px rgba(96,165,250,0.5); }
  100% { box-shadow: 0 0 0 2px rgba(96,165,250,0.4), 0 0 14px rgba(16,185,129,0.4); }
}
.pick-highlight { animation: pickPulse 1.8s ease-in-out infinite; }
`;
document.head.appendChild(styleEl);

let debounceTimer;
const input = document.getElementById('search-input');
const suggestions = document.getElementById('suggestions');
const optionsDiv = document.getElementById('bet-options');
const parlaysDiv = document.getElementById('parlays');
document.getElementById('refresh-parlays').addEventListener('click', loadParlays);
// Shared title-case helper
const toTitle = (s) => (s||'').toLowerCase().split(' ').map(w=> w ? (w[0].toUpperCase()+w.slice(1)) : '').join(' ');

input.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  const q = input.value.trim();
  if (!q) {
    suggestions.innerHTML = '';
    return;
  }
  debounceTimer = setTimeout(async () => {
    const mode = currentTab;
    suggestions.innerHTML = '';
    if (mode === 'teams') {
      const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        for (const s of data) {
          const a = document.createElement('button');
          a.className = 'w-full text-left px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50';
          a.textContent = `${s.name}`;
          a.onclick = () => selectEntity(s.name);
          suggestions.appendChild(a);
        }
      }
    } else {
      const res = await fetch(`/api/player_search?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (data && Array.isArray(data.players)) {
        for (const n of data.players) {
          const a = document.createElement('button');
          a.className = 'w-full text-left px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50';
          a.textContent = n;
          a.onclick = () => selectPlayer(n);
          suggestions.appendChild(a);
        }
      }
    }
  }, 200);
});

async function selectEntity(name) {
  suggestions.innerHTML = '';
  input.value = name;
  optionsDiv.innerHTML = '<div class="text-slate-300">Loading game cards...</div>';
  try {
    const res = await fetch(`/api/check_bet_games?q=${encodeURIComponent(name)}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    await renderGameCards(data.games || []);
  } catch (e) {
    optionsDiv.innerHTML = `<div class="text-red-400">${e.message}</div>`;
  }
}

async function selectPlayer(name) {
  suggestions.innerHTML = '';
  input.value = name;
  optionsDiv.innerHTML = '<div class="text-slate-300">Loading player props...</div>';
  try {
    const res = await fetch(`/api/player_props?name=${encodeURIComponent(name)}`);
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    renderPlayerProps(name, data.props || []);
  } catch (e) {
    optionsDiv.innerHTML = `<div class=\"text-red-400\">${e.message}</div>`;
  }
}

function renderOptions(opts) {
  if (!opts.length) {
    optionsDiv.innerHTML = '<div class="text-slate-300">No betting options found.</div>';
    return;
  }
  // Sort by probability desc (treat nulls as lowest)
  const sorted = [...opts].sort((a,b) => (b.probability??-1) - (a.probability??-1));
  optionsDiv.innerHTML = '';
  sorted.forEach((o, idx) => {
    const card = document.createElement('div');
    const isTop = idx === 0;
    const highlightClass = isTop ? ' border-2 border-orange-500 animate-ring-pulse-orange ' : '';
    card.className = 'bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3 relative' + highlightClass;
    card.innerHTML = `
      ${isTop ? '<div class="absolute top-2 right-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-lg shadow">Top pick</div>' : ''}
      <div class="text-xs uppercase tracking-wide text-slate-700">${(o.sport || '').toUpperCase()}</div>
      <div class="mt-1 font-semibold">${o.teams ? toTitle(o.teams) : (o.team ? (toTitle(o.team) + ' vs ' + toTitle(o.opponent || '')) : '')}</div>
      <div class="text-sm text-slate-700">${o.date ? new Date(o.date).toLocaleString('en-US', { timeZone: 'America/New_York' }) + ' ET' : ''}</div>
      <div class="mt-2 text-sm">
        <div><span class="font-semibold">Type:</span> ${o.type}</div>
        ${o.price !== undefined ? `<div><span class="font-semibold">Price:</span> ${o.price}</div>` : ''}
        ${o.line !== undefined ? `<div><span class="font-semibold">Line:</span> ${o.line}</div>` : ''}
        ${o.probability !== null && o.probability !== undefined ? `<div><span class="font-semibold">Hit %:</span> ${o.probability}%</div>` : ''}
        ${o.reason ? `<div class="text-slate-700 mt-1">${o.reason}</div>` : ''}
      </div>
      <div class="mt-3">
        <button class="w-full bg-black text-white rounded-xl py-2" onclick='openSaveModal(${JSON.stringify(o)})'>Save bet</button>
      </div>
    `;
    optionsDiv.appendChild(card);
  });
}

function renderPlayerProps(name, props) {
  optionsDiv.innerHTML = '';
  const title = document.createElement('div');
  title.className = 'text-white font-semibold';
  title.textContent = `Props for ${name}`;
  optionsDiv.appendChild(title);
  if (!props.length) {
    const empty = document.createElement('div');
    empty.className = 'text-slate-300';
    empty.textContent = 'No props available.';
    optionsDiv.appendChild(empty);
    return;
  }
  const groups = {};
  for (const p of props) {
    const mk = p.market;
    if (!groups[mk]) groups[mk] = [];
    groups[mk].push(p);
  }
  for (const key of Object.keys(groups)) {
    const box = document.createElement('div');
    box.className = 'bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3 space-y-2';
    const hdr = document.createElement('div');
    hdr.className = 'text-sm uppercase text-slate-600';
    hdr.textContent = key.replace('player_','').replace('_',' ');
    box.appendChild(hdr);
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-2 gap-2';
    for (const p of groups[key]) {
      const overBtn = document.createElement('button');
      overBtn.className = 'bg-white text-black rounded-xl border border-slate-300 px-3 py-2 text-sm text-left hover:bg-slate-50';
      overBtn.textContent = `Over ${p.line} (${p.over_price>0?'+':''}${p.over_price??'-'})`;
      overBtn.onclick = () => openSaveModal({ type:'player_over', line:p.line, price:p.over_price, sport:'nba', team:null, opponent:null, date:null });
      const underBtn = document.createElement('button');
      underBtn.className = 'bg-white text-black rounded-xl border border-slate-300 px-3 py-2 text-sm text-left hover:bg-slate-50';
      underBtn.textContent = `Under ${p.line} (${p.under_price>0?'+':''}${p.under_price??'-'})`;
      underBtn.onclick = () => openSaveModal({ type:'player_under', line:p.line, price:p.under_price, sport:'nba', team:null, opponent:null, date:null });
      grid.appendChild(overBtn);
      grid.appendChild(underBtn);
    }
    box.appendChild(grid);
    optionsDiv.appendChild(box);
  }
}

let currentTab = 'teams';
document.getElementById('tab-teams').addEventListener('click', ()=>{ currentTab='teams'; suggestions.innerHTML=''; optionsDiv.innerHTML=''; input.placeholder='Search team'; });
document.getElementById('tab-players').addEventListener('click', ()=>{ currentTab='players'; suggestions.innerHTML=''; optionsDiv.innerHTML=''; input.placeholder='Search player'; });

async function renderGameCards(games) {
  if (!games.length) {
    optionsDiv.innerHTML = '<div class="text-slate-300">No games found.</div>';
    return;
  }
  optionsDiv.innerHTML = '';
  for (const g of games) {
    const card = document.createElement('div');
    card.className = 'bg-white text-black rounded-2xl border border-slate-200 shadow-sm p-3 space-y-3';

    // Header line similar to home cards
    const homeML = (g.home_moneyline!==null && g.home_moneyline!==undefined) ? `(${g.home_moneyline>0?'+':''}${g.home_moneyline})` : '';
    const awayML = (g.away_moneyline!==null && g.away_moneyline!==undefined) ? `(${g.away_moneyline>0?'+':''}${g.away_moneyline})` : '';
    const header = document.createElement('div');
    header.innerHTML = `
      <div class="text-xs uppercase tracking-wide text-slate-700">${(g.sport||'').toUpperCase()}</div>
      <div class="mt-1 font-semibold">${toTitle(g.away_team)} ${awayML} @ ${toTitle(g.home_team)} ${homeML}</div>
      <div class="text-sm text-slate-700">${new Date(g.date).toLocaleString('en-US', { timeZone: 'America/New_York' })} ET${g.bookmaker ? ` · ${g.bookmaker}` : ''}</div>
    `;
    card.appendChild(header);

    // Odds chip grid similar to home
    const grid = document.createElement('div');
    grid.className = 'mt-1 grid grid-cols-4 gap-2 text-sm';
    grid.innerHTML = `
      <div><div class="text-slate-600">ML</div><div>${g.away_moneyline??'-'}</div><div>${g.home_moneyline??'-'}</div></div>
      <div><div class="text-slate-600">Spread</div><div>${(g.spread??'-')}</div></div>
      <div><div class="text-slate-600">Total</div><div>${(g.total??'-')}</div></div>
      <div><div class="text-slate-600">Book</div><div>${g.bookmaker||'-'}</div></div>
    `;
    card.appendChild(grid);

    // (Reverted) no full odds grid toggle for stability

    // Picks (auto-expanded)
    const picks = document.createElement('div');
    picks.className = 'pt-2 border-t border-slate-200 grid grid-cols-1 sm:grid-cols-2 gap-2';
    const buttons = [];
    // Build static buttons first
    if (g.away_moneyline!==null && g.away_moneyline!==undefined)
      buttons.push({ label: `${toTitle(g.away_team)} ML ${g.away_moneyline>0?'+':''}${g.away_moneyline} (Away)`, payload: { type:'moneyline', team:g.away_team, opponent:g.home_team, price:g.away_moneyline } });
    if (g.home_moneyline!==null && g.home_moneyline!==undefined)
      buttons.push({ label: `${toTitle(g.home_team)} ML ${g.home_moneyline>0?'+':''}${g.home_moneyline} (Home)`, payload: { type:'moneyline', team:g.home_team, opponent:g.away_team, price:g.home_moneyline } });
    if (g.spread!==null && g.spread!==undefined) {
      const awayLine = (g.spread!==null && g.spread!==undefined) ? (g.spread*-1) : null;
      buttons.push({ label: `${toTitle(g.home_team)} spread ${g.spread>0?'+':''}${g.spread} (Home)`, payload: { type:'spread', team:g.home_team, opponent:g.away_team, line:g.spread } });
      buttons.push({ label: `${toTitle(g.away_team)} spread ${awayLine>0?'+':''}${awayLine} (Away)`, payload: { type:'spread', team:g.away_team, opponent:g.home_team, line:awayLine } });
    }
    if (g.total!==null && g.total!==undefined) {
      buttons.push({ label: `Over ${g.total}`, payload: { type:'total', line:g.total } });
      buttons.push({ label: `Under ${g.total}`, payload: { type:'total', line:g.total } });
    }

    // Fetch suggested highlights from backend
    let highlightSet = new Set();
    try {
      const sr = await fetch(`/api/picks/suggest?sport=${encodeURIComponent(g.sport||'')}&game_id=${encodeURIComponent(g.game_id)}`);
      const sd = await sr.json();
      if (sd && sd.success && Array.isArray(sd.picks)) {
        // choose up to two; match by type/team/line when possible
        for (const sp of sd.picks.slice(0,2)) {
          const match = buttons.find(b => {
            const p = b.payload||{};
            if (sp.type.startsWith('total')) return p.type==='total' && p.line===sp.line;
            if (sp.type==='spread') return p.type==='spread' && p.team===sp.team && p.line===sp.line;
            if (sp.type==='moneyline') return p.type==='moneyline' && p.team===sp.team;
            return false;
          });
          if (match) highlightSet.add(match);
        }
      }
    } catch {}

    for (const b of buttons) {
      const btn = document.createElement('button');
      const hl = highlightSet.has(b) ? ' pick-highlight ' : '';
      btn.className = 'bg-white text-black rounded-xl border border-slate-300 px-3 py-2 text-sm text-left hover:bg-slate-50' + hl;
      // Pure label, no inline Ares metrics on game card
      btn.textContent = b.label;
      btn.onclick = async () => {
        const payload = { ...b.payload, sport:g.sport, game_id:g.game_id, date:g.date };
        // No pre-save evaluation UI per requirement
        openSaveModal(payload);
      };
      picks.appendChild(btn);
    }
    card.appendChild(picks);
    optionsDiv.appendChild(card);
  }
}

// Save modal logic
let pendingBet = null;
function openSaveModal(o) {
  pendingBet = o;
  document.getElementById('save-modal').classList.remove('hidden');
}
function closeSaveModal() {
  document.getElementById('save-modal').classList.add('hidden');
  pendingBet = null;
}
async function confirmSaveBet() {
  if (!pendingBet) return;
  // If not logged in, show a simple prompt
  try {
    const ping = await fetch('/api/parlays');
    const pj = await ping.json();
    if (pj && pj.success && Array.isArray(pj.parlays) && pj.parlays.length===0 && ping.status===200) {
      // could still be logged in with no parlays; proceed
    }
  } catch (e) {
    alert('Please log in to save picks.');
    return;
  }
  const isParlay = document.getElementById('opt-parlay').checked;
  const group_type = isParlay ? 'parlay' : 'single';
  let parlay_name = '';
  if (isParlay) {
    const sel = document.getElementById('existing-parlay');
    const existing = sel.value;
    const custom = document.getElementById('new-parlay-name').value.trim();
    parlay_name = custom || existing;
  }
  try {
    const payload = { ...pendingBet, group_type, parlay_name };
    const res = await fetch('/api/bets/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    closeSaveModal();
    await loadParlays();
    alert('Saved!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function loadParlays() {
  try {
    const res = await fetch('/api/parlays');
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    const list = data.parlays || [];
    if (!list.length) {
      parlaysDiv.innerHTML = '<div class="text-slate-600 text-sm">Nothing here. Search for your picks below!</div>';
      return;
    }
    parlaysDiv.innerHTML = '';
    for (const p of list) {
      const wrap = document.createElement('div');
      wrap.className = 'rounded-2xl border border-slate-200 p-3';
      const header = document.createElement('div');
      header.className = 'flex items-center justify-between';
      header.innerHTML = `<div class="font-semibold">${p.name}</div><div class="text-xs text-slate-600 uppercase">${p.status}</div>`;
      wrap.appendChild(header);
      const bets = document.createElement('div');
      bets.className = 'mt-2 space-y-2';
      for (const b of p.bets) {
        const row = document.createElement('div');
        row.className = 'bg-white text-black rounded-xl border border-slate-200 p-2 flex items-start justify-between';
        const left = document.createElement('div');
        left.innerHTML = `<div class="text-xs uppercase text-slate-600">${(b.sport||'').toUpperCase()}</div><div class="font-medium">${toTitle(b.team||'')} vs ${toTitle(b.opponent||'')}</div><div class="text-xs text-slate-600">${b.date ? new Date(b.date).toLocaleString('en-US', { timeZone: 'America/New_York' }) + ' ET' : ''}</div>`;
        // Metrics shown under team info
        const metrics = document.createElement('div');
        metrics.className = 'mt-1 text-xs text-slate-700 grid grid-cols-2 gap-x-4 gap-y-0.5';
        const parts = [];
        if (b.type) parts.push(`<div>Type: ${b.type}</div>`);
        if (b.line!==null && b.line!==undefined) parts.push(`<div>Line: ${b.line}</div>`);
        if (b.price!==null && b.price!==undefined) parts.push(`<div>Price: ${b.price}</div>`);
        if (b.p_model!==null && b.p_model!==undefined) parts.push(`<div>Model p: ${(b.p_model*100).toFixed(1)}%</div>`);
        if (b.implied_prob!==null && b.implied_prob!==undefined) parts.push(`<div>Book p: ${(b.implied_prob*100).toFixed(1)}%</div>`);
        if (b.edge!==null && b.edge!==undefined) parts.push(`<div>Edge: ${(b.edge*100).toFixed(1)}%</div>`);
        if (b.ev_per_100!==null && b.ev_per_100!==undefined) parts.push(`<div>EV $/100: ${b.ev_per_100.toFixed(1)}</div>`);
        if (b.kelly!==null && b.kelly!==undefined) parts.push(`<div>Stake%: ${(b.kelly*100).toFixed(1)}%</div>`);
        metrics.innerHTML = parts.join('');
        left.appendChild(metrics);
        const right = document.createElement('div');
        right.className = 'text-right text-sm flex items-start';
        const del = document.createElement('button');
        del.className = 'px-2 py-1 rounded-lg border border-red-300 text-red-600 hover:bg-red-50';
        del.textContent = '−';
        del.title = 'Remove pick';
        del.onclick = async () => {
          try {
            const res = await fetch('/api/bets/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: b.id }) });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Failed');
            await loadParlays();
          } catch (e) { alert('Error: ' + e.message); }
        };
        right.appendChild(del);
        row.appendChild(left);
        row.appendChild(right);
        bets.appendChild(row);
      }
      wrap.appendChild(bets);
      parlaysDiv.appendChild(wrap);
    }
  } catch (e) {
    parlaysDiv.innerHTML = `<div class=\"text-red-500\">Error loading: ${e.message}</div>`;
  }
}

// Prefill from ?s=TEAM query and auto-run
(() => {
  const params = new URLSearchParams(window.location.search);
  const s = params.get('s');
  if (s) {
    input.value = s;
    selectEntity(s);
  }
})();
</script>
<!-- Save Modal -->
<div id="save-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white text-black rounded-2xl border border-slate-200 shadow-lg w-full max-w-md p-4">
    <h3 class="text-lg font-semibold mb-2">Add this to a parlay?</h3>
    <p class="text-sm text-slate-700 mb-3">Choose Single to save alone, or add to an existing/new parlay. Up to 5 active setups.</p>
    <div class="space-y-2">
      <label class="flex items-center space-x-2"><input type="radio" name="save-type" id="opt-single" checked> <span>Single</span></label>
      <label class="flex items-center space-x-2"><input type="radio" name="save-type" id="opt-parlay"> <span>Parlay</span></label>
      <div id="parlay-controls" class="ml-6 space-y-2 hidden">
        <div>
          <label class="block text-sm text-slate-700">Existing parlay</label>
          <select id="existing-parlay" class="w-full px-3 py-2 rounded-xl border border-slate-300"></select>
        </div>
        <div>
          <label class="block text-sm text-slate-700">Or new parlay name</label>
          <input id="new-parlay-name" class="w-full px-3 py-2 rounded-xl border border-slate-300" placeholder="e.g., Sunday Picks" />
        </div>
      </div>
    </div>
    <div class="mt-4 flex justify-end space-x-2">
      <button class="px-4 py-2 rounded-xl border" onclick="closeSaveModal()">Cancel</button>
      <button class="px-4 py-2 rounded-xl bg-black text-white" onclick="confirmSaveBet()">Save</button>
    </div>
  </div>
</div>
<script>
// Toggle parlay controls
function updateParlayControls() {
  const show = document.getElementById('opt-parlay').checked;
  document.getElementById('parlay-controls').classList.toggle('hidden', !show);
}
document.getElementById('opt-single').addEventListener('change', updateParlayControls);
document.getElementById('opt-parlay').addEventListener('change', async () => {
  updateParlayControls();
  // load existing parlays into select
  try {
    const res = await fetch('/api/parlays');
    const data = await res.json();
    const sel = document.getElementById('existing-parlay');
    sel.innerHTML = '';
    (data.parlays||[]).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
  } catch {}
});
updateParlayControls();
// Initial load
loadParlays();
</script>
{% endblock %}

